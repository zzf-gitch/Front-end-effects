<!-- index.html -->
<!DOCTYPE html>
<html>
  <head>
    <title>虚拟列表</title>
    <meta charset="utf8" />
    <style>
      * {
        padding: 0;
        margin: 0;
      }
      body {
        width: 100vw;
        height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      #box {
        width: 300px;
        height: 500px;
        background: purple;
        overflow-y: scroll;
        box-sizing: border-box;
      }
    </style>
  </head>
  <body>
    <div id="box">
      <div id="box_container"></div>
    </div>
  </body>
  <script lang="text/javascript">
     (() =>{
        // 定义初始化数据
        let page = 1; // 页码
        let size = 1000; // 每页条数
        const height = 50; // 每条高度
        const  preLoadNum = 3; // 同时展示载页数
        const boxHeight = 500; // 容器高度
        let paddingBottom = 50; // 底部留白高度
        let listArr = []; // 用于存放列表数据
        
        const box = document.querySelector("#box");
        // 监听滚动
        box.addEventListener("scroll", (e) => {}, false)
    })()
    function createItem(page = 1, size = 10) {
    const fragment = document.createDocumentFragment()
    const box = document.createElement("div");
    
    box.className = `page_${page}`; // 给每页容器定一个类名，后面根据类名进行容器删除
    for (let i = 0; i < size; i++) {
      const element = document.createElement("div");

      element.style.width = "100%";
      element.style.height = "50px";
      element.style.color = "#fff";
      element.className = `item_${page * (i + 1)}`;
      element.innerText = `我是item——${((page - 1) * size) + i + 1}`;
      box.appendChild(element);
    }
    fragment.appendChild(box);
    
    return {fragment, box};
}
(() =>{
    // 定义初始化数据
    let page = 1; // 页码
    let size = 1000; // 每页条数
    const height = 50; // 每条高度
    const  preLoadNum = 3; // 同时展示载页数
    const boxHeight = 500; // 容器高度
    let listArr = []; // 用于存放列表数据

    const box = document.querySelector("#box");
    const boxContainer = document.querySelector("#box_container");
    
    const {fragment, box: boxList} = createItem(page, size)
    listArr.push(boxList); // 将数据放入列表中
    boxContainer.appendChild(fragment); // 载入初始数据
    // 监听滚动
    box.addEventListener("scroll", (e) => {
    
    }, false)
 })()
 box.addEventListener("scroll", (e) => {
        const scrollTop = e.target.scrollTop
        if (scrollTop >= nextHeight) {
            page++;
            // 顶部留白高度
            paddingTop = (page - preLoadNum) * (size * height) + paddingBottom;
            // 触发下一页的高度
            nextHeight = (page - 1) * (size * height) + paddingBottom + boxHeight;
            let fragment;
            // 判断该页数据是否已经存在列表中，存在则无须获取新的
            if (!listArr[page - 1]) {
              const {fragment: element, box: boxList} = createItem(page, size)
              fragment = element;
              listArr.push(boxList);
            } else {
              fragment = listArr[page - 1]
            }
            boxContainer.appendChild(fragment);
            // 判断是否存在需要删除的列表
            const hideElem = document.querySelector(`.page_${page - preLoadNum}`);
            if (hideElem) {
              // 如果有则删除列表并新增留白高度
              boxContainer.removeChild(hideElem);
              boxContainer.style.paddingTop = `${paddingTop}px`;
            }
        } else if (
            scrollTop <= (page - preLoadNum + 1) * size * height + paddingBottom && page > preLoadNum
        ) {
            page--;
            // 顶部留白高度
            paddingTop = (page - preLoadNum) * (size * height) + paddingBottom;
            // 触发下一页的高度
            nextHeight = (page - 1) * (size * height) + paddingBottom + boxHeight;
            // 取出上一页的数据并插入
            const fragment = listArr[page - preLoadNum];
            boxContainer.insertBefore(fragment, boxContainer.childNodes[0]);
            const hideElem = document.querySelector(`.page_${page + 1}`);
            if (hideElem) {
              // 删除下面的列表并减去顶部留白
              boxContainer.removeChild(hideElem);
              boxContainer.style.paddingTop = `${paddingTop}px`;
            }
        }
    }, false)
  </script>
</html>